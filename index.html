<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Voice Training Companion - Reading & Exercises</title>

  <!-- React / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Dyslexia-friendly spacing; simple sans for readability */
    .reading-text {
      font-family: Arial, Helvetica, sans-serif;
      line-height: 2;
      letter-spacing: 0.05em;
      word-spacing: 0.2em;
    }
    html { scroll-behavior: smooth; }
    button { min-height: 44px; min-width: 44px; }
    .floating-bubble {
      position: fixed; right: 20px; bottom: 80px; z-index: 1000;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .pitch-indicator { transition: all .3s ease; }
    button { -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    .safe-top { padding-top: env(safe-area-inset-top) }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom) }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function App() {
      const [tab, setTab] = useState('readings'); // 'readings' | 'exercises'
      const [readings, setReadings] = useState([]);
      const [exercises, setExercises] = useState([]);
      const [selectedReading, setSelectedReading] = useState(null);
      const [selectedExercise, setSelectedExercise] = useState(null);

      const [isDronePlaying, setIsDronePlaying] = useState(false);
      const [selectedNote, setSelectedNote] = useState('C4');
      const [currentPitch, setCurrentPitch] = useState(0);
      const [micPermission, setMicPermission] = useState('pending');
      const [audioInitialized, setAudioInitialized] = useState(false);
      const [showBubble, setShowBubble] = useState(false);
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [fontSize, setFontSize] = useState('large');

      /* Audio options */
      const [volumePct, setVolumePct] = useState(100); // 0–200
      const [timbre, setTimbre] = useState('sine'); // sine | triangle | sawtooth
      const [phoneBoost, setPhoneBoost] = useState(false);

      const baseGain = 0.2;

      const audioContextRef = useRef(null);
      const oscillatorRef = useRef(null);
      const oscHarmRef = useRef(null);    // 2nd harmonic when phoneBoost
      const oscHarmGainRef = useRef(null);
      const gainNodeRef = useRef(null);
      const presenceRef = useRef(null);
      const compressorRef = useRef(null);
      const analyserRef = useRef(null);
      const micStreamRef = useRef(null);
      const pitchDetectionRef = useRef(null);

      const notes = {
        'A3': 220.00, 'B3': 246.94, 'C4': 261.63, 'C#4': 277.18, 'D4': 293.66,
        'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00
      };

      /* Load JSON data */
      useEffect(() => {
        (async () => {
          try {
            const r = await fetch('data/readings.json'); const rj = await r.json();
            setReadings(Array.isArray(rj) ? rj : (rj.readings || []));
          } catch { /* fallback stays empty */ }
          try {
            const e = await fetch('data/exercises.json'); const ej = await e.json();
            setExercises(Array.isArray(ej) ? ej : (ej.exercises || []));
          } catch { /* fallback stays empty */ }
        })();
      }, []);

      /* Init mic + analyser */
      const initAudio = useCallback(async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
          });
          micStreamRef.current = stream;
          setMicPermission('granted');

          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }

          const source = audioContextRef.current.createMediaStreamSource(stream);
          analyserRef.current = audioContextRef.current.createAnalyser();
          analyserRef.current.fftSize = 2048;
          source.connect(analyserRef.current);

          setAudioInitialized(true);
          startPitchDetection();
        } catch (err) {
          console.error('Microphone error:', err);
          setMicPermission('denied');
        }
      }, []);

      /* Pitch detection (simple dominant-bin) */
      const startPitchDetection = useCallback(() => {
        if (!analyserRef.current || !audioContextRef.current) return;
        const bufferLength = analyserRef.current.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const detect = () => {
          if (!analyserRef.current) return;
          analyserRef.current.getByteFrequencyData(dataArray);

          let maxValue = 0, maxIndex = 0;
          for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > maxValue) { maxValue = dataArray[i]; maxIndex = i; }
          }

          if (maxValue > 50) {
            const nyquist = audioContextRef.current.sampleRate / 2;
            const frequency = (maxIndex * nyquist) / bufferLength;
            if (frequency > 80 && frequency < 500) setCurrentPitch(Math.round(frequency));
          } else {
            setCurrentPitch(0);
          }

          pitchDetectionRef.current = requestAnimationFrame(detect);
        };

        detect();
      }, []);

      /* Start/Stop drone with phone-friendly chain */
      const startDrone = useCallback(async () => {
        if (!audioContextRef.current) return;
        try {
          if (audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume(); // iOS unlock
          }

          const ctx = audioContextRef.current;

          const osc = ctx.createOscillator();
          osc.type = timbre;
          osc.frequency.value = notes[selectedNote];

          /* Harmonic (for phone clarity) */
          let osc2 = null, osc2Gain = null;
          if (phoneBoost) {
            osc2 = ctx.createOscillator();
            osc2.type = timbre;
            osc2.frequency.value = notes[selectedNote] * 2; // 2nd harmonic
            osc2Gain = ctx.createGain();
            osc2Gain.gain.value = 0.15; // subtle
          }

          /* Presence EQ + compressor then master gain */
          const presence = ctx.createBiquadFilter();
          presence.type = 'peaking';
          presence.frequency.value = phoneBoost ? 1200 : 1200;
          presence.Q.value = 1.0;
          presence.gain.value = phoneBoost ? 4 : 0; // +4 dB when enabled

          const comp = ctx.createDynamicsCompressor();
          comp.threshold.value = -24;
          comp.knee.value = 30;
          comp.ratio.value = 3;
          comp.attack.value = 0.003;
          comp.release.value = 0.25;

          const gain = ctx.createGain();
          gain.gain.value = baseGain * (volumePct / 100);

          // Connect chain
          osc.connect(presence);
          if (phoneBoost && osc2 && osc2Gain) {
            osc2.connect(osc2Gain);
            osc2Gain.connect(presence);
          }
          presence.connect(comp);
          comp.connect(gain);
          gain.connect(ctx.destination);

          osc.start();
          if (phoneBoost && osc2) osc2.start();

          oscillatorRef.current = osc;
          oscHarmRef.current = osc2;
          oscHarmGainRef.current = osc2Gain;
          presenceRef.current = presence;
          compressorRef.current = comp;
          gainNodeRef.current = gain;

          setIsDronePlaying(true);
        } catch (error) {
          console.error('Drone error:', error);
        }
      }, [selectedNote, volumePct, timbre, phoneBoost]);

      const stopDrone = useCallback(() => {
        if (oscillatorRef.current) { try { oscillatorRef.current.stop(); } catch {} oscillatorRef.current = null; }
        if (oscHarmRef.current)   { try { oscHarmRef.current.stop(); } catch {} oscHarmRef.current = null; }
        gainNodeRef.current = null; presenceRef.current = null; compressorRef.current = null; oscHarmGainRef.current = null;
        setIsDronePlaying(false);
      }, []);

      /* Resume for Safari when toggling monitor */
      const togglePitchMonitor = useCallback(async () => {
        if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
          try { await audioContextRef.current.resume(); } catch {}
        }
        setShowBubble(true);
      }, []);

      const adjustNote = useCallback((direction) => {
        const noteArray = Object.keys(notes);
        const currentIndex = noteArray.indexOf(selectedNote);
        let newIndex = direction === 'up' ? currentIndex + 1 : currentIndex - 1;
        newIndex = Math.max(0, Math.min(noteArray.length - 1, newIndex));
        const newNote = noteArray[newIndex];
        setSelectedNote(newNote);

        if (oscillatorRef.current) oscillatorRef.current.frequency.value = notes[newNote];
        if (oscHarmRef.current)    oscHarmRef.current.frequency.value = notes[newNote] * 2;
      }, [selectedNote]);

      /* Init mic/analyser once */
      useEffect(() => {
        initAudio();
        return () => {
          if (pitchDetectionRef.current) cancelAnimationFrame(pitchDetectionRef.current);
          if (oscillatorRef.current) { try { oscillatorRef.current.stop(); } catch {} }
          if (oscHarmRef.current)   { try { oscHarmRef.current.stop(); } catch {} }
          if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());
          if (audioContextRef.current) { try { audioContextRef.current.close(); } catch {} }
        };
      }, [initAudio]);

      /* Live update volume and presence when toggled */
      useEffect(() => {
        if (gainNodeRef.current) gainNodeRef.current.gain.value = baseGain * (volumePct / 100);
        if (presenceRef.current) presenceRef.current.gain.value = phoneBoost ? 4 : 0;
      }, [volumePct, phoneBoost]);

      /* UI helpers */
      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-400';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5) return 'bg-green-500';
        if (diff < 15) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}↓`;
        return `${currentPitch}↑`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 safe-top safe-bottom">
          {/* Header */}
          <header className="bg-white shadow-sm sticky top-0 z-50 safe-top">
            <div className="px-4 py-3 flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold text-gray-800">Voice Training Companion</h1>
                <p className="text-sm text-gray-600">Practice pitch while reading & exercises</p>
              </div>

              {/* Tabs */}
              <div className="flex gap-2">
                <button
                  className={`px-3 py-1 rounded ${tab==='readings'?'bg-purple-600 text-white':'bg-gray-100 text-gray-700'}`}
                  onClick={() => { setTab('readings'); setSelectedExercise(null); }}
                >Reading</button>
                <button
                  className={`px-3 py-1 rounded ${tab==='exercises'?'bg-purple-600 text-white':'bg-gray-100 text-gray-700'}`}
                  onClick={() => { setTab('exercises'); setSelectedReading(null); }}
                >Exercises</button>
              </div>
            </div>
          </header>

          {/* Main */}
          <div className="p-4 pb-24">
            {/* Mic prompt if denied */}
            {micPermission === 'denied' && (
              <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                <p className="text-red-800">🎤 Microphone access required for pitch detection</p>
                <button onClick={initAudio} className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg">Grant Access</button>
              </div>
            )}

            {/* Controls panel */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold mb-4">Pitch & Drone</h2>

              {/* Note */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Target Note</label>
                <select
                  value={selectedNote}
                  onChange={(e) => setSelectedNote(e.target.value)}
                  className="w-full p-3 text-lg border border-gray-300 rounded-lg"
                >
                  {Object.entries(notes).map(([note, freq]) => (
                    <option key={note} value={note}>{note} ({Math.round(freq)} Hz)</option>
                  ))}
                </select>
              </div>

              {/* Timbre + Phone boost */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Timbre</label>
                  <select
                    value={timbre}
                    onChange={(e)=>setTimbre(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  >
                    <option value="sine">Soft (sine)</option>
                    <option value="triangle">Warm (triangle)</option>
                    <option value="sawtooth">Bright (saw)</option>
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Tip: on phones, “Warm (triangle)” is easier to hear.</p>
                </div>
                <div className="flex items-end">
                  <label className="inline-flex items-center gap-2">
                    <input type="checkbox" className="w-5 h-5" checked={phoneBoost} onChange={()=>setPhoneBoost(!phoneBoost)} />
                    <span className="text-sm font-medium text-gray-700">Phone clarity boost (harmonic + presence)</span>
                  </label>
                </div>
              </div>

              {/* Volume */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Drone Volume: <span className="font-semibold">{volumePct}%</span>
                </label>
                <input
                  type="range" min="0" max="200" step="5" value={volumePct}
                  onChange={(e)=>setVolumePct(parseInt(e.target.value,10))}
                  className="w-full" aria-label="Drone volume percent"
                />
                <p className="text-xs text-gray-500 mt-1">100% = original loudness; 200% = 2× (safe).</p>
              </div>

              {/* Start/Monitor */}
              <div className="grid grid-cols-2 gap-3 mb-4">
                <button
                  onClick={isDronePlaying ? stopDrone : startDrone}
                  disabled={!audioInitialized}
                  className={`py-4 text-lg rounded-lg font-medium transition-colors ${
                    !audioInitialized ? 'bg-gray-300 text-gray-500'
                    : isDronePlaying ? 'bg-red-500 text-white' : 'bg-purple-500 text-white'
                  }`}
                >
                  {isDronePlaying ? '⏹ Stop Drone' : '▶ Start Drone'}
                </button>

                <button
                  onClick={togglePitchMonitor}
                  disabled={!audioInitialized}
                  className={`py-4 text-lg rounded-lg font-medium transition-colors ${
                    !audioInitialized ? 'bg-gray-300 text-gray-500'
                    : showBubble ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
                  }`}
                >
                  {showBubble ? '✓ Monitor On' : '👁 Show Monitor'}
                </button>
              </div>

              {/* Live pitch */}
              {audioInitialized && (
                <div className="text-center">
                  <div className="text-sm text-gray-600">Current Pitch</div>
                  <div className={`text-2xl font-bold ${
                    currentPitch === 0 ? 'text-gray-400'
                    : Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-green-500'
                    : Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-yellow-500'
                    : 'text-red-500'
                  }`}>
                    {currentPitch > 0 ? `${currentPitch} Hz` : 'No signal'}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">Target: {Math.round(notes[selectedNote])} Hz</div>
                </div>
              )}
            </div>

            {/* LISTS */}
            {tab === 'readings' && !selectedReading && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-semibold mb-4">Select Reading</h2>
                <div className="space-y-3">
                  {readings.map(r => (
                    <button key={r.id} onClick={()=>setSelectedReading(r)}
                      className="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-purple-50 transition-colors">
                      <div className="font-semibold text-lg">{r.title}</div>
                      {r.description && <div className="text-sm text-gray-600">{r.description}</div>}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {tab === 'exercises' && !selectedExercise && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-semibold mb-4">Select Exercise</h2>
                <div className="space-y-3">
                  {exercises.map(ex => (
                    <button key={ex.id} onClick={()=>setSelectedExercise(ex)}
                      className="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-purple-50 transition-colors">
                      <div className="font-semibold text-lg">{ex.title}</div>
                      {ex.goal && <div className="text-sm text-gray-600">{ex.goal}</div>}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* READING DETAIL */}
            {tab === 'readings' && selectedReading && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button onClick={()=>setSelectedReading(null)} className="text-purple-600 mb-2">← Back</button>
                    <h2 className="text-xl font-semibold">{selectedReading.title}</h2>
                    {selectedReading.description && <p className="text-sm text-gray-500">{selectedReading.description}</p>}
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={()=>{
                        const sizes=['small','medium','large','xlarge'];
                        const i=sizes.indexOf(fontSize); setFontSize(sizes[(i+1)%sizes.length]);
                      }}
                      className="px-3 py-1 bg-gray-200 rounded-lg text-sm"
                    >Aa</button>
                  </div>
                </div>
                <div className={`reading-text ${getFontSizeClass()} text-gray-800 whitespace-pre-wrap`}>{selectedReading.content}</div>
              </div>
            )}

            {/* EXERCISE DETAIL */}
            {tab === 'exercises' && selectedExercise && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button onClick={()=>setSelectedExercise(null)} className="text-purple-600 mb-2">← Back</button>
                    <h2 className="text-xl font-semibold">{selectedExercise.title}</h2>
                    {selectedExercise.goal && <p className="text-sm text-gray-500">{selectedExercise.goal}</p>}
                  </div>
                </div>

                {/* Optional instructions */}
                {selectedExercise.instructions?.length > 0 && (
                  <div className="mb-4">
                    <h3 className="font-semibold mb-2">Instructions</h3>
                    <ul className="list-disc pl-5 space-y-1">
                      {selectedExercise.instructions.map((t,i)=>(<li key={i}>{t}</li>))}
                    </ul>
                  </div>
                )}

                {/* Pairs table, if present */}
                {selectedExercise.pairs?.length > 0 && (
                  <div className="mb-4">
                    <h3 className="font-semibold mb-2">Consonant Buddies</h3>
                    <div className="overflow-x-auto">
                      <table className="min-w-full border text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="border px-2 py-1">Unvoiced</th>
                            <th className="border px-2 py-1">Example</th>
                            <th className="border px-2 py-1">Voiced</th>
                            <th className="border px-2 py-1">Example</th>
                          </tr>
                        </thead>
                        <tbody>
                          {selectedExercise.pairs.map((p,i)=>(
                            <tr key={i}>
                              <td className="border px-2 py-1 font-mono">{p.unvoiced}</td>
                              <td className="border px-2 py-1">{p.unvoicedWord}</td>
                              <td className="border px-2 py-1 font-mono">{p.voiced}</td>
                              <td className="border px-2 py-1">{p.voicedWord}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Extra voiced-only practice */}
                {selectedExercise.voicedPractice?.length > 0 && (
                  <div className="mb-4">
                    <h3 className="font-semibold mb-2">More voiced targets</h3>
                    <div className="flex flex-wrap gap-2">
                      {selectedExercise.voicedPractice.map((v,i)=>(
                        <span key={i} className="px-2 py-1 bg-purple-50 border border-purple-200 rounded">
                          <span className="font-mono">{v.phoneme}</span> — {v.word}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {/* Passage */}
                {selectedExercise.passage && (
                  <div className="mt-4">
                    <h3 className="font-semibold mb-2">Practice Passage</h3>
                    <div className="reading-text text-lg text-gray-800 whitespace-pre-wrap">{selectedExercise.passage}</div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Floating pitch bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => setBubbleExpanded(true)}
                  className={`w-20 h-16 rounded-full shadow-lg flex items-center justify-center text-white font-bold text-sm pitch-indicator ${getPitchColor()}`}
                >
                  {getPitchStatus()}
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm">Pitch Monitor</span>
                    <button onClick={()=>setBubbleExpanded(false)} className="text-gray-500 text-xl">×</button>
                  </div>
                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0 ? 'text-gray-400'
                      : Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-green-500'
                      : Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-yellow-500'
                      : 'text-red-500'
                    }`}>{currentPitch > 0 ? `${currentPitch} Hz` : '---'}</div>
                    <div className="text-xs text-gray-500">Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)</div>
                  </div>
                  <div className="flex gap-2 mb-3">
                    <button onClick={()=>adjustNote('down')} className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">↓</button>
                    <button onClick={()=>adjustNote('up')}   className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">↑</button>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${isDronePlaying ? 'bg-red-500' : 'bg-green-500'}`}
                    >
                      {isDronePlaying ? 'Mute' : 'Play'}
                    </button>
                    <button onClick={()=>{ setShowBubble(false); setBubbleExpanded(false); }} className="px-3 py-2 bg-gray-500 text-white rounded-lg text-sm">Hide</button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
